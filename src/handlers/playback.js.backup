const dingtalk = require('../adapters/dingtalk');
const { formatDuration, getMediaTypeIcon } = require('../utils/helpers');
const logger = require('../utils/logger');

class PlaybackHandlers {
  /**
   * 播放开始事件
   */
  static async playbackStart(data) {
    console.log('=== 播放开始事件完整数据 ===');
    console.log(JSON.stringify(data, null, 2));
    console.log('=== 数据结束 ===');
    
    const duration = data.RunTimeTicks ? formatDuration(data.RunTimeTicks) : '未知';
    const icon = getMediaTypeIcon(data.ItemType);
    
    // 更好的空值处理
    const userName = data.UserName || '未知用户';
    const itemName = data.ItemName || data.Name || '未知内容';
    const itemType = data.ItemType || '未知类型';
    const deviceName = data.DeviceName || '未知设备';
    const client = data.Client || '未知客户端';
    const ip = data.RemoteEndPoint || '未知';
    
    // 处理时间戳
    let timestampStr = '未知时间';
    try {
      if (data.Timestamp) {
        timestampStr = new Date(data.Timestamp).toLocaleString();
      }
    } catch (e) {
      timestampStr = new Date().toLocaleString();
    }
    
    const message = {
      title: `${icon} 开始播放`,
      content: `**用户**: ${userName}
**内容**: ${itemName}
**类型**: ${itemType}
**时长**: ${duration}
**设备**: ${deviceName}
**客户端**: ${client}
**IP地址**: ${ip}
**时间**: ${timestampStr}`,
      atAll: false
    };

    await dingtalk.sendMarkdown(message);
  }

  /**
   * 播放停止事件
   */
  static async playbackStop(data) {
    const playDuration = data.PlaybackDuration ? formatDuration(data.PlaybackDuration) : '未知';
    const totalDuration = data.RunTimeTicks ? formatDuration(data.RunTimeTicks) : '未知';
    const icon = getMediaTypeIcon(data.ItemType);
    
    // 计算播放进度
    let progress = 0;
    if (data.RunTimeTicks && data.PlaybackDuration) {
      progress = Math.round((data.PlaybackDuration / data.RunTimeTicks) * 100);
    }

    const userName = data.UserName || '未知用户';
    const itemName = data.ItemName || data.Name || '未知内容';
    const deviceName = data.DeviceName || '未知设备';

    const message = {
      title: `${icon} 播放完成`,
      content: `**用户**: ${userName}
**内容**: ${itemName}
**播放时长**: ${playDuration}
**总时长**: ${totalDuration}
**完成度**: ${progress}%
**设备**: ${deviceName}`,
      atAll: false
    };

    await dingtalk.sendMarkdown(message);
  }

  /**
   * 播放暂停事件
   */
  static async playbackPause(data) {
    const playDuration = data.PlaybackDuration ? formatDuration(data.PlaybackDuration) : '未知';
    const icon = getMediaTypeIcon(data.ItemType);
    
    const userName = data.UserName || '未知用户';
    const itemName = data.ItemName || data.Name || '未知内容';
    const deviceName = data.DeviceName || '未知设备';

    const message = {
      title: `${icon} 播放暂停`,
      content: `**用户**: ${userName}
**内容**: ${itemName}
**已播放**: ${playDuration}
**设备**: ${deviceName}`,
      atAll: false
    };

    await dingtalk.sendMarkdown(message);
  }

  /**
   * 播放继续事件
   */
  static async playbackUnpause(data) {
    const icon = getMediaTypeIcon(data.ItemType);
    
    const userName = data.UserName || '未知用户';
    const itemName = data.ItemName || data.Name || '未知内容';
    const deviceName = data.DeviceName || '未知设备';

    const message = {
      title: `${icon} 播放继续`,
      content: `**用户**: ${userName}
**内容**: ${itemName}
**设备**: ${deviceName}`,
      atAll: false
    };

    await dingtalk.sendMarkdown(message);
  }

  /**
   * 播放进度事件 - 只在里程碑点发送
   */
  static async playbackProgress(data) {
    if (!data.RunTimeTicks || !data.PlaybackPosition) return;
    
    const progress = Math.round((data.PlaybackPosition / data.RunTimeTicks) * 100);
    const milestonePoints = [25, 50, 75, 90];
    
    if (milestonePoints.includes(progress)) {
      const icon = getMediaTypeIcon(data.ItemType);
      
      const userName = data.UserName || '未知用户';
      const itemName = data.ItemName || data.Name || '未知内容';
      const deviceName = data.DeviceName || '未知设备';

      const message = {
        title: `${icon} 播放进度`,
        content: `**用户**: ${userName}
**内容**: ${itemName}
**播放进度**: ${progress}%
**设备**: ${deviceName}`,
        atAll: false
      };

      await dingtalk.sendMarkdown(message);
    }
  }

  /**
   * 播放速率变更事件
   */
  static async playbackRateChanged(data) {
    const icon = getMediaTypeIcon(data.ItemType);
    
    const userName = data.UserName || '未知用户';
    const itemName = data.ItemName || data.Name || '未知内容';
    const deviceName = data.DeviceName || '未知设备';

    const message = {
      title: `${icon} 播放速率变更`,
      content: `**用户**: ${userName}
**内容**: ${itemName}
**播放速率**: ${data.PlaybackRate || 1}x
**设备**: ${deviceName}`,
      atAll: false
    };

    await dingtalk.sendMarkdown(message);
  }

  /**
   * 播放错误事件
   */
  static async playbackError(data) {
    const userName = data.UserName || '未知用户';
    const itemName = data.ItemName || data.Name || '未知内容';
    const deviceName = data.DeviceName || '未知设备';
    const client = data.Client || '未知客户端';

    const message = {
      title: `❌ 播放错误`,
      content: `**用户**: ${userName}
**内容**: ${itemName}
**设备**: ${deviceName}
**客户端**: ${client}
**错误信息**: ${data.ErrorMessage || '未知错误'}

> ⚠️ 请检查媒体文件是否正常或网络连接是否稳定`,
      atAll: true
    };

    await dingtalk.sendMarkdown(message);
  }
}

module.exports = PlaybackHandlers;
